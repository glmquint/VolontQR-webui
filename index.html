<html>
  <head>
    <meta charset="utf-8" />
    <!-- <script src="https://unpkg.com/pdf-lib"></script> -->
    <script src="pdf-lib.min.js"></script>
    <!-- <script src="https://unpkg.com/qrcode-generator"></script> -->
    <script src="qrcode.js"></script>
  </head>

  <body style="margin: 0; padding: 0; font-family: Arial, sans-serif;">
    <div style="display: grid; grid-template-columns: 1fr 2fr; height: 100vh; margin: 0;">
      <div>
        <input type="file" id="file" accept=".pdf" style="width: 100%; box-sizing: border-box; font-family: monospace; font-size: 16px;" />
        <textarea id="msg" style="width: 100%; height: 10%; box-sizing: border-box; font-family: monospace; font-size: 16px;" placeholder="Enter text to generate QR code"></textarea>
        <button id="preview" onclick="update(true)">Preview First Page</button>
        <button id="generate" onclick="update()">Generate All</button>
        <progress id="progress" style="width: 100%; height: 20px;"></progress>
      </div>
      <iframe id="pdf" style="width: 100%; height: 100%;"></iframe>
    </div>
  </body>

  <script>
    function preCreatePdf() {
      btn = document.getElementById('generate');
      btn.disabled = true;
      btn.innerText = 'Generating...';
    }
    function postCreatePdf() {
      btn = document.getElementById('generate');
      btn.disabled = false;
      btn.innerText = 'Generate All';
    }
    async function createPdf(links, file, preview = false) {
      preCreatePdf();
      const pdfDoc = await PDFLib.PDFDocument.create();

      links = links.split('\n').map(link => link.trim()).filter(link => link !== '');
      if (preview) {
        links = links.slice(0, 1); // Only preview the first link
      }

      const progress = document.getElementById('progress');
      progress.value = 0;
      progress.max = links.length;

      const filePdfDoc = file ? await PDFLib.PDFDocument.load(file) : null;

      await Promise.all(links.map(async link => {
        let i;
        for (i=1; i<41; i++) {
          try {
            svg_tag = create_qrcode(link, i, 'M', 'Byte', 'UTF-8');
            break;
          } catch {
            continue;
          }
        }
        let svg_path = svg_tag.split('<path d="')[1].split(' " stroke="transparent"')[0];

        width = 350;
        height = 400;
        page = null;
        if (file) {
          pages = await pdfDoc.copyPages(filePdfDoc, [0])
          page = pdfDoc.addPage(pages[0]);
          width = pages[0].getWidth();
          height = pages[0].getHeight();

        } else {
          page = await pdfDoc.addPage([width, height]);
        }
        // TODO: use https://kazuhikoarase.github.io/qrcode-generator/js/demo/
        // to find all generated QR codes sizes
        w = [58, 66, 74, 82, 90, 98, 106, 114, 122, 130][i-1];
        h = w;
        page.moveTo(width/2 - w/2, height/2 - h/2); // (0, 0) is bottom-left corner
        page.drawRectangle({width: w, height: h, color: PDFLib.rgb(1, 1, 1)});
        page.moveTo(width/2 - w/2, height/2 + h/2); // (0, 0) is bottom-left corner
        page.drawSvgPath(svg_path, {color: PDFLib.rgb(0, 0, 0)});
        // page.drawText(link);

        console.log('Page created for link:', link);
        progress.value += 1;
        // page.drawText(link);
      })).then(async () => {
        progress.removeAttribute('value'); 
        if (preview) {
          const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
          document.getElementById('pdf').src = pdfDataUri;
        } else {
          const pdfBytes = await pdfDoc.save();
          var blob=new Blob([pdfBytes], {type: "application/pdf"});
          var link=document.createElement('a');
          link.href=window.URL.createObjectURL(blob);
          link.download="tickets.pdf";
          link.click();
          link.remove();
        }
        console.log('PDF created');
        progress.value = 0; // Reset progress bar
      });

      postCreatePdf();
    }

    function create_qrcode(text, typeNumber, errorCorrectionLevel, mode, mb) {
      qrcode.stringToBytes = qrcode.stringToBytesFuncs[mb];
      var qr = qrcode(typeNumber || 4, errorCorrectionLevel || 'M');
      qr.addData(text, mode);
      qr.make();
      r = qr.createSvgTag({ alt: '</svg>puke'});
      return r;
    };
    async function update(preview = false) {
      links = document.getElementById('msg').value
      file = document.getElementById('file').files[0];
      if (file) {
        file = await file.arrayBuffer();
      }
      createPdf(links, file, preview);
    }
    update(true); // Initial preview
  </script>
</html>
